package com.liujiahui.www.service.wrapper;

import java.util.Arrays;
import java.util.Collections;
import java.util.List;
import org.fisco.bcos.sdk.abi.FunctionEncoder;
import org.fisco.bcos.sdk.abi.FunctionReturnDecoder;
import org.fisco.bcos.sdk.abi.TypeReference;
import org.fisco.bcos.sdk.abi.datatypes.Address;
import org.fisco.bcos.sdk.abi.datatypes.Function;
import org.fisco.bcos.sdk.abi.datatypes.Type;
import org.fisco.bcos.sdk.abi.datatypes.generated.tuples.generated.Tuple1;
import org.fisco.bcos.sdk.client.Client;
import org.fisco.bcos.sdk.contract.Contract;
import org.fisco.bcos.sdk.crypto.CryptoSuite;
import org.fisco.bcos.sdk.crypto.keypair.CryptoKeyPair;
import org.fisco.bcos.sdk.model.CryptoType;
import org.fisco.bcos.sdk.model.TransactionReceipt;
import org.fisco.bcos.sdk.model.callback.TransactionCallback;
import org.fisco.bcos.sdk.transaction.model.exception.ContractException;

@SuppressWarnings("unchecked")
public class ContractProxyService extends Contract {
    public static final String[] BINARY_ARRAY = {"60806040526001805460ff60a01b1916905534801561001d57600080fd5b5060405161063e38038061063e83398101604081905261003c916102b8565b6001600160a01b03841661006b5760405162461bcd60e51b815260040161006290610371565b60405180910390fd5b6001600160a01b0383166100915760405162461bcd60e51b815260040161006290610371565b600380546001600160a01b038087166001600160a01b0319928316179092556000805486841692169190911790819055604051632ea3cdd960e11b8152911690635d479bb2906100e5903090600401610347565b600060405180830381600087803b1580156100ff57600080fd5b505af1158015610113573d6000803e3d6000fd5b5050600480546001600160a01b038087166001600160a01b031992831617808455600280549093163017928390556040516357451a2160e01b815290821695506357451a21945061016993929091169101610347565b600060405180830381600087803b15801561018357600080fd5b505af1158015610197573d6000803e3d6000fd5b50506004805460025460405163e852485b60e01b81526001600160a01b03928316955063e852485b94506101d1933393909216910161032d565b600060405180830381600087803b1580156101eb57600080fd5b505af11580156101ff573d6000803e3d6000fd5b5050600580546001600160a01b0319166001600160a01b038581169190911791829055600254604051632ea3cdd960e11b81529282169450635d479bb2935061024d92911690600401610347565b600060405180830381600087803b15801561026757600080fd5b505af115801561027b573d6000803e3d6000fd5b5050600180546001600160a01b031916331790555061039a945050505050565b80516001600160a01b03811681146102b257600080fd5b92915050565b600080600080608085870312156102cd578384fd5b6102d7868661029b565b93506102e6866020870161029b565b92506102f5866040870161029b565b9150610304866060870161029b565b905092959194509250565b600b81526a6c69756a6961687569315960a81b602082015260400190565b6001600160a01b0392831681529116602082015260400190565b6001600160a01b038216815260406020820181905260009061036a90830161030f565b9392505050565b6020808252600f908201526e496e76616c6964206164647265737360881b604082015260600190565b610295806103a96000396000f3fe6080604052600436106100385760003560e01c80630900f0101461005c57806359679b0f1461007c578063f851a440146100a757610047565b36610047576100456100bc565b005b34801561005357600080fd5b506100456100bc565b34801561006857600080fd5b506100456100773660046101db565b6100d3565b34801561008857600080fd5b50610091610199565b60405161009e9190610229565b60405180910390f35b3480156100b357600080fd5b506100916101a8565b6003546100d1906001600160a01b03166101b7565b565b6004805460405163817c1a2160e01b81526001600160a01b039091169163817c1a219161010291339101610229565b60206040518083038186803b15801561011a57600080fd5b505afa15801561012e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906101529190610209565b6101775760405162461bcd60e51b815260040161016e9061023d565b60405180910390fd5b600380546001600160a01b0319166001600160a01b0392909216919091179055565b6003546001600160a01b031681565b6001546001600160a01b031681565b3660008037600080366000845af43d6000803e8080156101d6573d6000f35b3d6000fd5b6000602082840312156101ec578081fd5b81356001600160a01b0381168114610202578182fd5b9392505050565b60006020828403121561021a578081fd5b81518015158114610202578182fd5b6001600160a01b0391909116815260200190565b602080825260089082015267139bc81c9a59da1d60c21b60408201526060019056fea264697066735822122006883ddeda3368b60cdb406d9be53470d98aa82c15fa52c76dd1078a98dc5c1864736f6c634300060a0033"};

    public static final String BINARY = org.fisco.bcos.sdk.utils.StringUtils.joinAll("", BINARY_ARRAY);

    public static final String[] SM_BINARY_ARRAY = {"60806040526001805460ff60a01b1916905534801561001d57600080fd5b5060405161064038038061064083398101604081905261003c916102b9565b6001600160a01b03841661006c57604051636381e58960e11b815260040161006390610372565b60405180910390fd5b6001600160a01b03831661009357604051636381e58960e11b815260040161006390610372565b600380546001600160a01b038087166001600160a01b031992831617909255600080548684169216919091179081905560405163651c699360e11b815291169063ca38d326906100e7903090600401610348565b600060405180830381600087803b15801561010157600080fd5b505af1158015610115573d6000803e3d6000fd5b5050600480546001600160a01b038087166001600160a01b0319928316178084556002805490931630179283905560405162696f3160e41b81529082169550630696f310945061016a93929091169101610348565b600060405180830381600087803b15801561018457600080fd5b505af1158015610198573d6000803e3d6000fd5b505060048054600254604051632745893960e21b81526001600160a01b039283169550639d1624e494506101d2933393909216910161032e565b600060405180830381600087803b1580156101ec57600080fd5b505af1158015610200573d6000803e3d6000fd5b5050600580546001600160a01b0319166001600160a01b03858116919091179182905560025460405163651c699360e11b8152928216945063ca38d326935061024e92911690600401610348565b600060405180830381600087803b15801561026857600080fd5b505af115801561027c573d6000803e3d6000fd5b5050600180546001600160a01b031916331790555061039b945050505050565b80516001600160a01b03811681146102b357600080fd5b92915050565b600080600080608085870312156102ce578384fd5b6102d8868661029c565b93506102e7866020870161029c565b92506102f6866040870161029c565b9150610305866060870161029c565b905092959194509250565b600b81526a6c69756a6961687569315960a81b602082015260400190565b6001600160a01b0392831681529116602082015260400190565b6001600160a01b038216815260406020820181905260009061036b908301610310565b9392505050565b6020808252600f908201526e496e76616c6964206164647265737360881b604082015260600190565b610296806103aa6000396000f3fe6080604052600436106100385760003560e01c8063344a77171461005c5780639b8376e414610087578063f1522800146100a757610047565b36610047576100456100bc565b005b34801561005357600080fd5b506100456100bc565b34801561006857600080fd5b506100716100d3565b60405161007e919061022a565b60405180910390f35b34801561009357600080fd5b506100456100a23660046101dc565b6100e2565b3480156100b357600080fd5b506100716101a9565b6003546100d1906001600160a01b03166101b8565b565b6003546001600160a01b031681565b600480546040516349823ce960e11b81526001600160a01b039091169163930479d2916101119133910161022a565b60206040518083038186803b15801561012957600080fd5b505afa15801561013d573d6000803e3d6000fd5b505050506040513d601f19601f82011682018060405250810190610161919061020a565b61018757604051636381e58960e11b815260040161017e9061023e565b60405180910390fd5b600380546001600160a01b0319166001600160a01b0392909216919091179055565b6001546001600160a01b031681565b3660008037600080366000845af43d6000803e8080156101d7573d6000f35b3d6000fd5b6000602082840312156101ed578081fd5b81356001600160a01b0381168114610203578182fd5b9392505050565b60006020828403121561021b578081fd5b81518015158114610203578182fd5b6001600160a01b0391909116815260200190565b602080825260089082015267139bc81c9a59da1d60c21b60408201526060019056fea2646970667358221220c13d988fbafdef1b29f25556b907549a7b7c2a3faaf30c8013d92b141b679f2164736f6c634300060a0033"};

    public static final String SM_BINARY = org.fisco.bcos.sdk.utils.StringUtils.joinAll("", SM_BINARY_ARRAY);

    public static final String[] ABI_ARRAY = {"[{\"inputs\":[{\"internalType\":\"address\",\"name\":\"implementation_\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"addr\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"veri_Address\",\"type\":\"address\"},{\"internalType\":\"address\",\"name\":\"token\",\"type\":\"address\"}],\"stateMutability\":\"nonpayable\",\"type\":\"constructor\"},{\"stateMutability\":\"nonpayable\",\"type\":\"fallback\"},{\"inputs\":[],\"name\":\"_implementation\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[],\"name\":\"admin\",\"outputs\":[{\"internalType\":\"address\",\"name\":\"\",\"type\":\"address\"}],\"stateMutability\":\"view\",\"type\":\"function\"},{\"inputs\":[{\"internalType\":\"address\",\"name\":\"newCont\",\"type\":\"address\"}],\"name\":\"upgrade\",\"outputs\":[],\"stateMutability\":\"nonpayable\",\"type\":\"function\"},{\"stateMutability\":\"payable\",\"type\":\"receive\"}]"};

    public static final String ABI = org.fisco.bcos.sdk.utils.StringUtils.joinAll("", ABI_ARRAY);

    public static final String FUNC__IMPLEMENTATION = "_implementation";

    public static final String FUNC_ADMIN = "admin";

    public static final String FUNC_UPGRADE = "upgrade";

    protected ContractProxyService(String contractAddress, Client client, CryptoKeyPair credential) {
        super(getBinary(client.getCryptoSuite()), contractAddress, client, credential);
    }

    public static String getBinary(CryptoSuite cryptoSuite) {
        return (cryptoSuite.getCryptoTypeConfig() == CryptoType.ECDSA_TYPE ? BINARY : SM_BINARY);
    }

    public String _implementation() throws ContractException {
        final Function function = new Function(FUNC__IMPLEMENTATION,
                Arrays.<Type>asList(),
                Arrays.<TypeReference<?>>asList(new TypeReference<Address>() {}));
        return executeCallWithSingleValueReturn(function, String.class);
    }

    public String admin() throws ContractException {
        final Function function = new Function(FUNC_ADMIN,
                Arrays.<Type>asList(),
                Arrays.<TypeReference<?>>asList(new TypeReference<Address>() {}));
        return executeCallWithSingleValueReturn(function, String.class);
    }

    public TransactionReceipt upgrade(String newCont) {
        final Function function = new Function(
                FUNC_UPGRADE,
                Arrays.<Type>asList(new org.fisco.bcos.sdk.abi.datatypes.Address(newCont)),
                Collections.<TypeReference<?>>emptyList());
        return executeTransaction(function);
    }

    public byte[] upgrade(String newCont, TransactionCallback callback) {
        final Function function = new Function(
                FUNC_UPGRADE,
                Arrays.<Type>asList(new org.fisco.bcos.sdk.abi.datatypes.Address(newCont)),
                Collections.<TypeReference<?>>emptyList());
        return asyncExecuteTransaction(function, callback);
    }

    public String getSignedTransactionForUpgrade(String newCont) {
        final Function function = new Function(
                FUNC_UPGRADE,
                Arrays.<Type>asList(new org.fisco.bcos.sdk.abi.datatypes.Address(newCont)),
                Collections.<TypeReference<?>>emptyList());
        return createSignedTransaction(function);
    }

    public Tuple1<String> getUpgradeInput(TransactionReceipt transactionReceipt) {
        String data = transactionReceipt.getInput().substring(10);
        final Function function = new Function(FUNC_UPGRADE,
                Arrays.<Type>asList(),
                Arrays.<TypeReference<?>>asList(new TypeReference<Address>() {}));
        List<Type> results = FunctionReturnDecoder.decode(data, function.getOutputParameters());
        return new Tuple1<String>(

                (String) results.get(0).getValue()
        );
    }

    public static ContractProxyService load(String contractAddress, Client client, CryptoKeyPair credential) {
        return new ContractProxyService(contractAddress, client, credential);
    }

    public static ContractProxyService deploy(Client client, CryptoKeyPair credential, String implementation_, String addr, String veri_Address, String token) throws ContractException {
        String encodedConstructor = FunctionEncoder.encodeConstructor(Arrays.<Type>asList(new org.fisco.bcos.sdk.abi.datatypes.Address(implementation_),
                new org.fisco.bcos.sdk.abi.datatypes.Address(addr),
                new org.fisco.bcos.sdk.abi.datatypes.Address(veri_Address),
                new org.fisco.bcos.sdk.abi.datatypes.Address(token)));
        return deploy(ContractProxyService.class, client, credential, getBinary(client.getCryptoSuite()), encodedConstructor);
    }
}